---
title: "MCP Server for Query API"
description: "AI agent access to Emerge Query API via Model Context Protocol"
---

## Overview

The Emerge MCP server provides AI agents (Claude Code, Claude Desktop, Cursor) with secure access to the Query API. Instead of making direct HTTP calls, AI tools use the Model Context Protocol with session-based credentials.

<Note>
The MCP server is a **thin wrapper** around Query API sync endpoints. For direct HTTP access, see [Query API Documentation](/query/overview).
</Note>

## Architecture

```
┌─────────────┐      MCP Protocol       ┌──────────────┐      HTTP/JSON      ┌──────────────┐
│  AI Agent   │────────────────────────▶│  MCP Server  │────────────────────▶│  Query API   │
│             │  (session credentials)  │              │  (Bearer token)     │              │
│ Claude Code │                         │   NestJS     │                     │   FastAPI    │
│   Cursor    │                         │ StreamableHTTP│                     │  ClickHouse  │
└─────────────┘                         └──────────────┘                     └──────────────┘
```

### What's Different from Direct Query API

| Feature | MCP Server | Direct HTTP |
|---------|------------|-------------|
| **Protocol** | MCP (JSON-RPC over HTTP) | REST API |
| **Credentials** | Session-based (provide once) | Per-request (Bearer token) |
| **Tool Discovery** | Built-in (`tools/list`) | OpenAPI spec |
| **AI Integration** | Native support | Manual implementation |
| **Best For** | AI agents, IDE plugins | Server-to-server, custom apps |

### Key Benefits

- **Session Management**: Provide credentials once on connection, not per request
- **Native AI Support**: Works out-of-the-box with Claude, Cursor, VS Code
- **Type Safety**: Structured tool calling with validated parameters
- **Same Data**: Identical responses to Query API sync endpoints

## Deployment

### Staging
- **URL**: `https://mcp.staging.emergedata.ai`
- **Purpose**: Testing and development
- **Data**: Test users only

### Production
- **URL**: `https://mcp.emergedata.ai`
- **Purpose**: Production applications
- **Data**: Real user data

## Available Tools

The MCP server exposes 5 tools that map 1:1 to Query API sync endpoints:

| MCP Tool | Query API Endpoint | Data Type |
|----------|-------------------|-----------|
| `get_search_data` | `/v1/sync/get_search` | Search history |
| `get_youtube_data` | `/v1/sync/get_youtube` | YouTube watch history |
| `get_browsing_data` | `/v1/sync/get_browsing` | Web browsing |
| `get_ads_data` | `/v1/sync/get_ads` | Ad interactions |
| `get_receipts_data` | `/v1/sync/get_receipts` | Purchase receipts |

See [MCP Tools Reference](/ai/mcp-tools) for detailed tool documentation.

## Getting Started

### 1. Obtain Credentials

You'll need:
- **auth_token**: Bearer token for Query API authentication
- **uid**: User reference ID (e.g., `alice@yourcompany.com`)

Contact your Emerge integration team to obtain credentials.

### 2. Configure Your AI Tool

Choose your platform:

<CardGroup cols={2}>
  <Card title="Claude Code" icon="code" href="/ai/mcp-setup#claude-code">
    Command-line AI agent
  </Card>
  <Card title="Claude Desktop" icon="desktop" href="/ai/mcp-setup#claude-desktop">
    Desktop application
  </Card>
  <Card title="Cursor" icon="cursor" href="/ai/mcp-setup#cursor">
    AI-powered code editor
  </Card>
  <Card title="VS Code" icon="code" href="/ai/mcp-setup#vs-code">
    Visual Studio Code extension
  </Card>
</CardGroup>

See [MCP Setup Guide](/ai/mcp-setup) for detailed configuration instructions.

### 3. Verify Connection

After configuration, verify the connection:

```bash
# Test the health endpoint
curl https://mcp.emergedata.ai/mcp/health

# Expected response
{
  "status": "ok",
  "service": "mcp-server",
  "version": "1.0.0",
  "protocol": "streamable-http"
}
```

### 4. Use Tools

Once connected, AI agents can call tools directly:

```typescript
// Example: Get search history
const result = await use_mcp_tool({
  tool: "get_search_data",
  arguments: {
    begin: "2024-01-01T00:00:00Z",
    end: "2024-01-31T23:59:59Z",
    limit: 100
  }
});
```

## Authentication

The MCP server supports two authentication modes:

### Session Credentials (Recommended)

Provide credentials once during connection:

```json
{
  "url": "https://mcp.emergedata.ai/mcp?auth_token=YOUR_TOKEN&uid=user@example.com"
}
```

All subsequent tool calls use these credentials automatically.

### Per-Tool Credentials

Override session credentials for specific tool calls:

```typescript
await use_mcp_tool({
  tool: "get_search_data",
  arguments: {
    auth_token: "DIFFERENT_TOKEN",
    uid: "different@example.com",
    begin: "2024-01-01T00:00:00Z"
  }
});
```

## Response Format

All tools return the same structure:

```json
{
  "success": true,
  "count": 10,
  "has_more": true,
  "next_cursor": "eyJsYXN0X2V2ZW50X2lkIjoxMjM0NX0=",
  "applied_ingested_end": "2024-01-15T10:30:00Z",
  "data": [
    // ... event objects
  ]
}
```

See [MCP Tools Reference](/ai/mcp-tools) for detailed response schemas.

## Pagination

Use cursor-based pagination for large datasets:

```typescript
let cursor = null;
let allData = [];

do {
  const result = await use_mcp_tool({
    tool: "get_search_data",
    arguments: {
      begin: "2024-01-01T00:00:00Z",
      limit: 1000,
      cursor: cursor  // undefined on first call
    }
  });

  allData.push(...result.data);
  cursor = result.next_cursor;
} while (result.has_more);
```

See [Pagination Guide](/query/pagination) for best practices.

## Error Handling

When a tool call fails, it returns:

```json
{
  "isError": true,
  "content": [
    {
      "type": "text",
      "text": "Detailed error message"
    }
  ]
}
```

Common errors:
- **401 Unauthorized**: Invalid or missing credentials
- **400 Bad Request**: Invalid parameters (e.g., malformed timestamp)
- **500 Internal Server Error**: Query API or database error

## Troubleshooting

### Connection Issues

**Problem**: Cannot connect to MCP server
**Solution**:
1. Verify URL is correct (staging vs production)
2. Check firewall/network settings
3. Ensure credentials are valid

### Authentication Errors

**Problem**: 401 Unauthorized responses
**Solution**:
1. Verify auth_token is current (tokens may expire)
2. Check uid matches your organization's format
3. Contact integration team to verify access

### Empty Results

**Problem**: Tool returns `count: 0, data: []`
**Solution**:
1. Check time range (`begin`/`end` parameters)
2. Verify user has consented data
3. Check category filter isn't too restrictive

## Rate Limits

The MCP server inherits rate limits from the Query API:

- **Requests**: 100 requests per minute per IP
- **Data**: 10,000 events per request (recommended limit: 1000)
- **Concurrent**: 10 concurrent connections per organization

See [Query API Overview](/query/overview#rate-limits) for details.

## Source Code

The MCP server is open-source:

- **Repository**: [github.com/emerge-protocol/emgcp](https://github.com/emerge-protocol/emgcp)
- **Issues**: [Report bugs or request features](https://github.com/emerge-protocol/emgcp/issues)
- **License**: MIT

## Related Documentation

<CardGroup cols={2}>
  <Card title="MCP Setup" icon="gear" href="/ai/mcp-setup">
    Configure Claude, Cursor, VS Code
  </Card>
  <Card title="MCP Tools Reference" icon="tools" href="/ai/mcp-tools">
    Detailed tool documentation
  </Card>
  <Card title="Query API Overview" icon="database" href="/query/overview">
    Direct HTTP API access
  </Card>
  <Card title="Workflow Examples" icon="lightbulb" href="/ai/examples">
    Integration patterns
  </Card>
</CardGroup>
